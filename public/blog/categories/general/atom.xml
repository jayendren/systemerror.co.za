<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: General | RANDOM ramblings]]></title>
  <link href="http://www.systemerror.co.za/blog/categories/general/atom.xml" rel="self"/>
  <link href="http://www.systemerror.co.za/"/>
  <updated>2015-04-28T20:35:23+00:00</updated>
  <id>http://www.systemerror.co.za/</id>
  <author>
    <name><![CDATA[jayendren]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[FreeBSD Nginx+passenger]]></title>
    <link href="http://www.systemerror.co.za/blog/2015/04/27/freebsd-nginx_passenger/"/>
    <updated>2015-04-27T18:45:00+00:00</updated>
    <id>http://www.systemerror.co.za/blog/2015/04/27/freebsd-nginx_passenger</id>
    <content type="html"><![CDATA[<p>{% img center https://forums.freebsd.org/styles/freebsd/xenforo/freebsd_logo.png %}</p>

<p>{% blockquote passenger installation, https://gist.githubusercontent.com/geoffgarside/855302/raw/cc24215b0a2601911b84f48092627b9976fc3332/install-passenger-nginx.sh %}
{% endblockquote %}
&#8220;`
#!/bin/sh
#
# Pre-requisites:
#   FreeBSD
#   Passenger installed as a gem
# Optional:
#   Ruby Enterprise Edition instead of lang/ruby18
#</p>

<p>make -C /usr/ports/www/nginx clean patch apply-slist install-rc-script
source_dir=<code>ls -d /usr/ports/www/nginx/work/nginx-*</code>	# should be only one</p>

<p>passenger-install-nginx-module –prefix=/usr/local \
	–nginx-source-dir=”${source_dir}” \
	–extra-configure-flags=”–with-cc-opt=&#8221;-I /usr/local/include&#8221; \
				–with-ld-opt=&#8221;-L /usr/local/lib&#8221; \
				–conf-path=/usr/local/etc/nginx/nginx.conf \
				–sbin-path=/usr/local/sbin/nginx \
				–pid-path=/var/run/nginx.pid \
				–error-log-path=/var/log/nginx-error.log \
				–user=www –group=www \
				–http-client-body-temp-path=/var/tmp/nginx/client_body_temp \
				–http-proxy-temp-path=/var/tmp/nginx/proxy_temp \
				–http-fastcgi-temp-path=/var/tmp/nginx/fastcgi_temp \
				–http-log-path=/var/log/nginx-access.log \
				–with-http_addition_module \
				–with-http_gzip_static_module \
				–with-http_ssl_module \
				–with-http_stub_status_module \
				–with-ipv6”
&#8220;`</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[FreeBSD EZJAILS]]></title>
    <link href="http://www.systemerror.co.za/blog/2015/04/26/freebsd-ezjails/"/>
    <updated>2015-04-26T18:45:00+00:00</updated>
    <id>http://www.systemerror.co.za/blog/2015/04/26/freebsd-ezjails</id>
    <content type="html"><![CDATA[<p>{% img center https://forums.freebsd.org/styles/freebsd/xenforo/freebsd_logo.png %}</p>

<p>{% blockquote FreeBSD Forums, https://forums.freebsd.org/threads/howto-quick-setup-of-jail-on-zfs-using-ezjail-with-pf-nat.30063/ %}
{% endblockquote %}
July 26, 2014 update: different configuration for new pkg tool</p>

<p>Following scenario is presented:</p>

<p>&#8220;`
                   /———– our host ————–\
–{ internet } — [ 192.0.2.1 ] —jail— [ 10.6.6.6 ]</p>

<p>&#8220;`</p>

<p>where:</p>

<p>em0 is an egress interface (internet facing) 
lo666 is a custom loopback interface (host only)</p>

<p>192.0.2.1 is a public IP address on em0
10.6.6.6 is a jail IP address on lo666</p>

<p>Goal is to create a jail where simple WWW service is running.</p>

<p>Prerequisites:</p>

<p>Installed sysutils/ezjail either from ports or from pre-built repository
ZFS pool where jail dataset will be created; pool zpool is used here</p>

<p>The /etc/rc.conf
Enable PF, ZFS, ezjail and IP forwarding. Create and configure lo666 interface. Lines in question from /etc/rc.conf:</p>

<p>&#8220;`
cloned_interfaces=”lo666”
ifconfig_lo666_alias0=”inet 10.6.6.6 netmask 255.255.255.255”</p>

<p>gateway_enable=”YES”</p>

<p>pf_enable=”YES”
ezjail_enable=”YES”
zfs_enable=”YES”</p>

<p>&#8220;`</p>

<p>Bring the interface up. In 9.0-RELEASE it’s enough to do:</p>

<p>&#8220;`
# ifconfig lo666 create</p>

<p>&#8220;`
This creates the interface and assigns the alias from /etc/rc.conf. In case IP address is not up, bring it up manually:</p>

<p><code>
# ifconfig lo666 alias 10.6.6.6 netmask 255.255.255.255 up
</code></p>

<p>Enable IP forwarding: 
# sysctl net.inet.ip.forwarding=1</p>

<p>Setup PF
Only the NAT part of the PF is shown here, configuration of PF is not subject of this howto. 
/etc/pf.conf:</p>

<p>&#8220;`
ext_if=”em0”
jail_if=”lo666”</p>

<p>IP_PUB=”192.0.2.1”
IP_JAIL_WWW=”10.6.6.6”</p>

<p>NET_JAIL=”10.6.6.0/24”</p>

<p>PORT_WWW=”{80,443}”</p>

<p>scrub in all</p>

<h1 id="nat-all-jail-traffic">nat all jail traffic</h1>
<p>nat pass on $ext_if from $NET_JAIL to any -&gt; $IP_PUB</p>

<h1 id="www">WWW</h1>
<p>rdr pass on $ext_if proto tcp from any to $IP_PUB port $PORT_WWW -&gt; $IP_JAIL_WWW</p>

<h1 id="demo-only-passing-all-traffic">demo only, passing all traffic</h1>
<p>pass out
pass in</p>

<p>&#8220;`</p>

<p>Check /etc/pf.conf for any mistakes:</p>

<p><code>
# pfctl -nf /etc/pf.conf
</code>
If no error is shown, start the firewall.</p>

<p>&#8220;`
# /etc/rc.d/pf start</p>

<p><code>
Verify the firewall is enabled, check the NAT rules (ALTQ warnings can be safely ignored). 
</code></p>

<h1 id="pfctl--e">pfctl -e</h1>
<p>pfctl: pf already enabled</p>

<h1 id="pfctl--sn">pfctl -sn</h1>
<p>nat pass on em0 inet from 10.6.6.0/24 to any -&gt; 192.0.2.1
rdr pass on em0 inet proto tcp from any to 192.0.2.1 port = http -&gt; 10.6.6.6
rdr pass on em0 inet proto tcp from any to 192.0.2.1 port = https -&gt; 10.6.6.6
&#8220;`</p>

<p>Configure ezjail
By default all jails are stored under /usr/jails directory. However I’ll use /local/jails in my setup.</p>

<p>First create a ZFS dataset:</p>

<p><code>
# zfs create -o mountpoint=/local/jails zpool/jails
# chmod 700 /local/jails &amp;&amp; chown root:wheel /local/jails
</code></p>

<p>Main ezjail configuration is stored under /usr/local/etc/ezjail.conf. Uncomment and set at least these parameters:</p>

<p><code>
ezjail_jaildir=/local/jails
ezjail_ftphost=ftp.sk.freebsd.org
ezjail_use_zfs="YES"
ezjail_jailzfs="zpool/jails"
</code></p>

<p>Use the ftp host closest to you. 
There are several options how to install the base. Here I’ll just fetch the base from FTP, see the ezjail-admin(8) for details.</p>

<p><code>
# ezjail-admin install
</code></p>

<p>Minimum userland - basejail - has been fetched. You can see it on separate dataset:</p>

<p><code>
# zfs list
zpool                  333M  1.63G    31K  none
zpool/jails            332M  1.63G    47K  /local/jails
zpool/jails/basejail   330M  1.63G   330M  /local/jails/basejail
zpool/jails/newjail   1.70M  1.63G  1.70M  /local/jails/newjail
</code></p>

<p>I plan to create more than one jail, I don’t want to set all system settings manually for each and every one of them. There’s where jail flavor comes in place.
happycamper.local is my domain, I’ll use the name happycamper for a flavor.</p>

<p>&#8220;`
# mkdir -p /local/jails/flavours/happycamper/etc/rc.d
# cd /local/jails/flavours/happycamper/etc
# vi rc.conf
sshd_enable=”YES”
syslogd_flags=”-ss”</p>

<h1 id="cp--p-etcresolvconf-">cp -p /etc/resolv.conf .</h1>
<p># cp -p /local/jails/flavours/example/etc/rc.d/ezjail.flavour.example rc.d/ezjail.flavour.happycamper
&#8220;`</p>

<p>Flavors are stored under $jailroot/flavours directory ($jailroot == /local/jails). I’ve created rc.conf and resolv.conf files - these will be copied to new jail with happycamper flavor.</p>

<p>For the demonstration I want to create custom group, user and install screen package. This is done upon first jail startup by ezjail.flavour script.</p>

<p>In vi editor I have replaced all “example” words by “happycamper”. All examples are shown there, easy to understand. In FreeBSD 10 there’s a new package management. There are no more pkg_* commands.</p>

<p>Prior to FreeBSD 10 you can use the following flavor config: 
&#8220;`
pw group add users
echo -n ‘$1$p75bbfK.$Kz3dwkoVlgZrfLZdAXQt91’ |\
pw user add martin -g users -G wheel -s /bin/csh -d /home/martin -m -H 0</p>

<p>chown -R martin:users /home/martin</p>

<p>pkg_add -r screen
&#8220;`</p>

<p>If you are running FreeBSD 10 and later: 
&#8220;`
pw group add users
echo -n ‘$1$p75bbfK.$Kz3dwkoVlgZrfLZdAXQt91’ |\
pw user add martin -g users -G wheel -s /bin/csh -d /home/martin -m -H 0</p>

<p>chown -R martin:users /home/martin
# don’t ask - just do
export ASSUME_ALWAYS_YES=YES
pkg bootstrap
pkg install screen
&#8220;`</p>

<p>Now I’m finally ready to create new jail with a flavor.</p>

<p>&#8220;`
# ezjail-admin create -f happycamper -c zfs www 10.6.6.6
ZFS: create the jail filesystem
/local/jails/www/.
/local/jails/www/./etc
/local/jails/www/./etc/rc.d
/local/jails/www/./etc/rc.d/ezjail.flavour.happycamper
/local/jails/www/./etc/rc.conf
/local/jails/www/./etc/resolv.conf
5 blocks</p>

<p>Starting the jail:</p>

<h1 id="usrlocaletcrcdezjail-start-www">/usr/local/etc/rc.d/ezjail start www</h1>
<p>Configuring jails:.
Starting jails: www.
&#8220;`</p>

<p>It might take a second or two as the flavor script is executed upon first start; it does remove itself afterward. To check the jail status:</p>

<p>&#8220;`
# jls
   JID  IP Address      Hostname                      Path
     2  10.6.6.6        www                           /local/jails/www</p>

<p>&#8220;`</p>

<p>To access the jail ezjail-admin command can be used:</p>

<p><code>
# ezjail-admin console www
</code></p>

<p>Now the apache can be installed and configured, jail itself is ready.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Puppet User Group Johannesburg - Foreman]]></title>
    <link href="http://www.systemerror.co.za/blog/2015/04/21/puppet-usergroup-foreman/"/>
    <updated>2015-04-21T18:45:00+00:00</updated>
    <id>http://www.systemerror.co.za/blog/2015/04/21/puppet-usergroup-foreman</id>
    <content type="html"><![CDATA[<p>{% img center http://photos3.meetupstatic.com/photos/event/c/1/7/a/global_434209530.jpeg %}</p>

<p>{% blockquote Merrit, http://www.meetup.com/Johannesburg-Puppet-User-Group/events/221520257/ %}
Puppet MeetUp! Foreman demo and overview
FNB Randburg - 2015-04-21 18:45
Hi All</p>

<p>Please join us for our second meetup.</p>

<p>Jayendren is going to give a talk on Foreman.</p>

<p>The second talk is not finalized so please give us your input on the mailing list. With the imminent release of puppet 4, perhaps a puppet 4 introduction/changes.
{% endblockquote %}
Presentation: 
{% youtube ig3A8LcbHlc %}
Demos: 
{% youtube 5rXAEI7Pvq8 %}
{% youtube bJWerFLB9L0 %}
{% youtube NdMVl24qwF4 %}
{% youtube bnxkpWKXYfg %}
{% youtube fj7Yh6MFrgw %}
{% youtube JZZXgClWc3A %}
{% youtube As-m1fHf-MQ %}</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby ektoplazm.com Scraper]]></title>
    <link href="http://www.systemerror.co.za/blog/2015/03/16/ekto_scaper/"/>
    <updated>2015-03-16T15:20:00+00:00</updated>
    <id>http://www.systemerror.co.za/blog/2015/03/16/ekto_scaper</id>
    <content type="html"><![CDATA[<p>{% img center http://www.ektoplazm.com/i/g-header.jpg %}
&#8220;` 
Requires:
 rubygems:
  nokogiri, open-uri, colorize
  download manager:
   axel or wget (update @dlmgmr variable with path)</p>

<p>Sample usage:
  Interactive:
   ./ekto_scaper</p>

<p>CLI:
   ./ekto_scaper –url http://www.ektoplazm.com/style/progressive –rating 96</p>

<p>Sample output:</p>

<p>./ekto.rb –url http://www.ektoplazm.com/style/progressive –rating 96                                                                                             130 ↵
DBG: URL: http://www.ektoplazm.com/style/progressive - RATING: 96</p>

<p>loading…please wait.
 …</p>

<p>=== Progressive Releases at Ektoplazm ===</p>

<p>Release:                                                          Rating:              Status:                   Completed:</p>

<p>DJ Basilisk – Replicant Redux                                     93                   skipping                  98.076923</p>

<p>DJ Basilisk – Nocturnal Wanderlust                                96                   starting                  100.000000
 Initializing download: http://www.ektoplazm.com/files/DJ%20Basilisk%20-%20Nocturnal%20Wanderlust.mp3
 File size: 191565824 bytes
 Opening output file DJ Basilisk - Nocturnal Wanderlust.mp3.0
 Starting download</p>

<p>Connection 1 finished                                                          ]
 Connection 3 finished                                                          ]
 Connection 2 finished                                                          ]
 Connection 0 finished                                                          ]</p>

<p>Downloaded 182.7 megabytes in 5:01 seconds. (621.36 KB/s)
Author: Jayendren Maduray <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#106;&#097;&#121;&#101;&#110;&#100;&#114;&#101;&#110;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;">&#106;&#097;&#121;&#101;&#110;&#100;&#114;&#101;&#110;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;</a>
&#8220;`
~~~ ruby 
require ‘rubygems’
require ‘nokogiri’
require ‘open-uri’
require ‘colorize’</p>

<h1 id="global-variables">GLOBAL VARIABLES</h1>
<p>@rating = 95
@dlmgmr = “axel -a”</p>

<p>def ekto_input</p>

<p>if (ARGV[0].to_s.match(/^&#8211;help$/))</p>

<pre><code>cmd = $0

printf "About:\n".blue
printf "Ruby (nokogiri) scraper for www.ektoplazm.com \n".green
printf "Use case: \n".green
printf "1. Scan all pages on http://www.ektoplazm.com/style/progressive\n\n".green
printf "2. Find and download all MP3 packs with rating &gt; 95%\n".green

printf "Usage:\n".blue
printf "Interactive:     #{cmd}\n".green
printf "CLI        :     #{cmd} --url 'http://www.ektoplazm.com/style/progressive' --rating '95'\n\n".green
exit 0
</code></pre>

<p>elsif (ARGV[0].to_s.match(/^&#8211;url$/))</p>

<pre><code>unless (ARGV[1].to_s.empty?) or ! (ARGV[1].to_s.match(/^http\:\/\/www\.ektoplazm\.com\/style\//))
  @ekto_url = ARGV[1]
else 
  puts "invalid url !".red; exit 1
end

if (ARGV[2].to_s.match(/^\-\-rating$/))

  unless (ARGV[3].to_s.empty?) or ! (ARGV[3].to_i &lt; 100)   
    @ekto_rating = ARGV[3]   
  else 
    puts "rating cannot be &gt; 100 !".red; exit 1
  end        

end
</code></pre>

<p>else</p>

<pre><code>printf "Interactive mode started: \n\n".cyan
printf "Type ektoplazm URL &gt; ".green

@ekto_url = gets.strip.to_s
unless ! @ekto_url.match(/^http\:\/\/www\.ektoplazm\.com\/style\//)
  printf "Type the rating: &gt; ".green
  @ekto_rating  = gets.strip.to_s

  unless ! (@ekto_rating.to_i &lt; 100)
    printf "\n"
  else 
    puts "rating cannot be &gt; 100 !".red; exit 1
  end

else 
  puts "invalid url !".red; exit 1
end 
</code></pre>

<p>end<br />
  puts “DBG: URL: #{@ekto_url} - RATING: #{@ekto_rating}\n”.green
  puts “loading…please wait.\n”.green</p>

<p>end #def</p>

<p>def ekto_scrape(ekto_url,ekto_rating)
  url     = ekto_url<br />
  @rating = ekto_rating.to_i
  @doc    = Nokogiri::HTML(open(url))
  pgs     = @doc.css(“.navigation”).css(“.pages”).text.split(/\s/)[-1].to_i
  post    = @doc.css(“.post”)</p>

<p>printf “\n===\s%s===\n\n”.blue % [ @doc.at_css(“title”).text.split(/-/)[0], pgs - pgs + 1 ]
  printf “%-65s %-20s %-25s %-2s\n\n”.cyan % [ ‘Release:’, ‘Rating:’, ‘Status:’, ‘Completed:’]</p>

<p>#page 1
  post.each {|d|
    title = d.css(“h1”).css(“a”).text
    score = d.css(“strong”).to_s.split(/&gt;|\%/)[-4].to_i
    dll   = d.css(“.dll”).css(“a”).to_s.split(/&#8221;/)[1]</p>

<pre><code>unless score &lt; @rating
  printf "%-65s %-20s %-25s %-1f\n".cyan % [ title, score, 'starting', ((1 / pgs.to_f) * 100).to_f ]
  system("#{@dlmgmr} #{dll}")
  puts 
else 
  printf "%-65s %-20s %-25s %-1f\n".red % [ title, score, 'skipping', ((1 / pgs.to_f) * 100).to_f ]
end 
puts   }
</code></pre>

<p>#remaining pages
  for pages in 2..pgs</p>

<pre><code>url = "#{ekto_url}/page/#{pages}"
@doc = Nokogiri::HTML(open(url))

post = @doc.css(".post")
post.each {|d|
  title = d.css("h1").css("a").text
  score = d.css("strong").to_s.split(/\&gt;|\%/)[-4].to_i
  dll   = d.css(".dll").css("a").to_s.split(/\"/)[1]

  unless score &lt; @rating
    printf "%-65s %-20s %-25s %-1f\n".cyan % [ title, score, 'starting', ((pages.to_f / pgs.to_f) * 100).to_f ]
    system("#{@dlmgmr} #{dll}")
    puts 
  else 
    printf "%-65s %-20s %-25s %-1f\n".red % [ title, score, 'skipping', ((pages.to_f / pgs.to_f) * 100).to_f ]
  end 
  puts
}
</code></pre>

<p>end #for pages</p>

<p>end #def</p>

<h2 id="main">MAIN</h2>
<p>begin
  ekto_input
  ekto_scrape(@ekto_url,@ekto_rating)
end
~~~</p>
]]></content>
  </entry>
  
</feed>
